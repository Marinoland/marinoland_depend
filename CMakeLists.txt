cmake_minimum_required(VERSION 2.8)
project (depend)


function(fetch_depends listpath)
	message("Fetch dependencies from: ${listpath}")
	IF(EXISTS ${listpath})
		FILE(STRINGS ${listpath} DEPENDLIST)
		list(REMOVE_DUPLICATES DEPENDLIST)
		foreach(repo ${DEPENDLIST})
			MESSAGE("Process repo: ${repo}")
			if(EXISTS ./${repo})
				MESSAGE("Skipping git clone ${repo}. Already there.")
				fetch_depends(./${repo}/depend.list)
			else()
				MESSAGE("ADDING REPO: ${repo}")
				set(REPOURL git@github.com:Marinoland/marinoland_${repo}.git)
				execute_process(COMMAND git clone ${REPOURL} ${repo})
				fetch_depends(./${repo}/depend.list)
				execute_process(COMMAND cmake -DDEP_ROOT:STRING=${CMAKE_CURRENT_SOURCE_DIR}/../ . WORKING_DIRECTORY ${repo})

				execute_process(COMMAND cmake --build . --config Release WORKING_DIRECTORY ./${repo})
			endif()
			if(EXISTS "./${repo}/depend.libs") 
				file(STRINGS ./${repo}/depend.libs tmp)
				foreach(line ${tmp})
					file(APPEND depend.libs ${line} \n)
				endforeach()
			endif()
			if(EXISTS ./${repo}/depend.includedirs) 
				file(STRINGS ./${repo}/depend.includedirs tmp)
				foreach(line ${tmp})
					file(APPEND depend.includedirs ${line} \n)
				endforeach()
			endif()
			if(EXISTS ./${repo}/depend.linkdirs) 
				file(STRINGS ./${repo}/depend.linkdirs tmp)
				foreach(line ${tmp})
					file(APPEND depend.linkdirs ${line} \n)
				endforeach()
			endif()
			if(EXISTS ./${repo}/depend.defs) 
				file(STRINGS ./${repo}/depend.defs tmp)
				foreach(line ${tmp})
					file(APPEND depend.defs ${line} \n)
				endforeach()
			endif()
		endforeach()
	ENDIF()
endfunction()

file(WRITE depend.libs "")
file(WRITE depend.includedirs "")
file(WRITE depend.linkdirs "")
file(WRITE depend.defs "")
fetch_depends(${PROJECT_SOURCE_DIR}/depend.list)
